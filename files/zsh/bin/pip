#!/usr/bin/env python3

from os import environ
from os.path import basename, dirname
from shutil import get_terminal_size
from subprocess import run
from sys import argv, stdin
from typing import NoReturn

__dirname__ = dirname(__file__)
__name__ = basename(argv[0])
__args__ = argv[1:]


def cont() -> NoReturn:
    ret = run([__name__, *__args__])
    exit(ret.returncode)


def paths() -> None:
    new_paths = (path for path in environ["PATH"].split(":") if path != __dirname__)
    environ["PATH"] = ":".join(new_paths)


def is_venv() -> bool:
    return environ.get("VIRTUAL_ENV") is not None


def is_install() -> bool:
    if not len(__args__):
        return False
    else:
        return __args__[0] == "install"


def main() -> NoReturn:
    paths()
    proceed = is_venv() or not stdin.isatty() or not is_install()

    if proceed:
        cont()
    else:
        cols, _ = get_terminal_size()
        sep = "-" * cols
        cmds = " ".join((__name__, *__args__))
        ask = f"Not in virtual environment:\n{sep}\n{cmds}\n{sep}\nProceed (y/n)?"
        ans = input(ask)
        if ans in {"y", "yes", "1"}:
            cont()
        else:
            exit(1)


try:
    main()
except KeyboardInterrupt:
    pass
